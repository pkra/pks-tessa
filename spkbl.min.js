/* Speakable Text-To-Speech player 0.4.1-pre | https://github.com/tollwerk/speakable */
var __spreadArray=this&&this.__spreadArray||function(t,e,s){if(s||2===arguments.length)for(var n,i=0,r=e.length;i<r;i++)!n&&i in e||((n=n||Array.prototype.slice.call(e,0,i))[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))};!function(n,s){var i=[],r=null,o=/[’'‘`“”"[\](){}…,.!;?\-:\u0964\u0965]\s*$/,a=/(\w)[·‧*:](\w)/gi,l={selector:".spkbl",local:!0,multivoice:!0,src:null,hidden:!1,player:null,l18n:{play:"Read text",pause:"Pause",progress:"Progress",stop:"Resume"}},h=["address","article","aside","blockquote","details","dialog","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","nav","ol","p","pre","section","table","ul"];function p(t){return t&&"object"==typeof t&&!Array.isArray(t)}function c(t){for(var e,s=[],n=1;n<arguments.length;n++)s[n-1]=arguments[n];if(!s.length)return t;var i=s.shift();if(p(t)&&p(i))for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&p(i[r])?(t[r]||Object.assign(t,((e={})[r]={},e)),c(t[r],i[r])):Object.assign(t,((e={})[r]=i[r],e));return c.apply(void 0,__spreadArray([t],s,!1))}function u(t,e){this.lang=t,this.multivoice=e,this.items=[]}function d(t,e){var s=this,t=(this.element=t,this.options=this.configure(e,"data-spkbl"),this.src=null,this.audio=null,this.utterances=[],this.currentUtterance=0,this.length=0,this.offset=0,this.progress=0,this.paused=!1,this.nextOnResume=!1,this.player=null,this.controls={},this.defaultPlayer),e=(this.options.player&&("function"==typeof this.options.player?t=this.options.player:"function"==typeof n[this.options.player]&&(t=n[this.options.player])),this.options.src&&(this.audioReady=!1,this.audio=new Audio(this.options.src),this.audio.addEventListener("loadstart",function(){s.audioReady=!1}),this.audio.addEventListener("canplaythrough",function(){s.audioReady=!0}),this.audio.addEventListener("error",function(){s.audio=null})),this.buildPlayer(t),new u(this.determineLanguage(this.element)||"en",this.options.multivoice));this.setUtterances(e.chunked(this.element)),this.injectPlayer()}u.prototype.parse=function(t){var s=this;return t.childNodes.forEach(function(t){var e;t.nodeType===Element.ELEMENT_NODE?t.hasAttribute("data-spkbl-skip")||(e=s.multivoice&&t.lang||s.lang,s.items.push({type:1+(-1!==h.indexOf(t.tagName.toLowerCase())),lang:e,node:t,items:new u(e,s.multivoice).parse(t)})):t.nodeType===Element.TEXT_NODE&&(e=t.nodeValue).trim().length&&(e=(e=e.replace(/[\s\r\n]+/g," ")).replace(a,"$1$2"),s.items.push({type:0,lang:s.lang,node:t,text:e}))}),this.items},u.prototype.createSentence=function(t){return{lang:t,chunks:[]}},u.prototype.createChunks=function(t){var s=this,n=[],i=null,r=function(t){if(null===i)i=s.createSentence(t.lang),t.type?(t.items.forEach(r),i&&i.chunks.length&&n.push(i),i=null):i.chunks.push({node:t.node,text:t.text});else switch(t.type){case 2:i.chunks.length?(n.push(i),i=s.createSentence(t.lang)):i.lang=t.lang,t.items.forEach(r),i&&i.chunks.length&&n.push(i),i=null;break;case 1:var e;"BR"===t.node.tagName.toUpperCase()?(e=i.chunks.length)&&(e=i.chunks[e-1].text,o.test(e)?/\s$/.test(e)||i.chunks.push({node:t.node,text:" "}):i.chunks.push({node:t.node,text:" . "})):t.lang===i.lang?t.items.forEach(r):(e=i.lang,i.chunks.length&&n.push(i),i=s.createSentence(t.lang),t.items.forEach(r),i.chunks.length&&n.push(i),i=s.createSentence(e));break;default:i.chunks.push({node:t.node,text:t.text})}};return this.parse(t).forEach(r),i&&i.chunks.length&&(n[n.length]=i),n},u.prototype.map=function(t){var e={lang:t.lang,text:"",map:new Map};return t.chunks.forEach(function(t){e.map.set(e.text.length,t.node),e.text+=t.text}),e},u.prototype.chunked=function(t){t=this.createChunks(t);if(!t.length)return[];for(var e=t.map(this.map),i=[e.shift()];e.length;)!function(){var s,t=e.shift(),n=i.length-1;t.lang===i[n].lang?(o.test(i[n].text)||(i[n].text+=". "),i[n].text="".concat(i[n].text.trim()," "),s=i[n].text.length,i[n].text+=t.text,t.map.forEach(function(t,e){i[n].map.set(s+e,t)})):i.push(t)}();return i},d.prototype.configure=function(t,e){var s,n,i={};for(s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n="".concat(e,"-").concat(s),p(t[s])?i[s]=this.configure(t[s],n):this.element.hasAttribute(n)?i[s]="1"===(n=this.element.getAttribute(n))||"true"===n.toLowerCase()||"0"!==n&&"false"!==n.toLowerCase()&&n:i[s]=t[s]);return i},d.prototype.determineLanguage=function(t){return t.lang||(t.parentNode?this.determineLanguage(t.parentNode):null)},d.prototype.defaultPlayer=function(t){var e={player:s.createElement("div"),controls:{}};return e.controls.play=e.player.appendChild(s.createElement("button")),e.controls.play.innerHTML=t.options.l18n.play,e.controls.pause=e.player.appendChild(s.createElement("button")),e.controls.pause.innerHTML=t.options.l18n.pause,e.controls.progress=e.player.appendChild(s.createElement("progress")),e.controls.progress.innerHTML="0%",e.controls.stop=e.player.appendChild(s.createElement("button")),e.controls.stop.innerHTML=t.options.l18n.stop,e},d.prototype.buildPlayer=function(t){t=t(this);this.player=t.player,this.controls=t.controls,this.player.classList.add("spkbl-player","spkbl-player--inactive"),this.player.role="group",this.options.hidden&&this.player.setAttribute("aria-hidden","true"),this.controls.play.type="button",this.controls.play.classList.add("spkbl-ctrl","spkbl-ctrl--play"),this.controls.play.addEventListener("click",this.play.bind(this)),this.controls.pause.type="button",this.controls.pause.classList.add("spkbl-ctrl","spkbl-ctrl--pause"),this.controls.pause.addEventListener("click",this.pause.bind(this)),this.controls.pause.setAttribute("aria-pressed","false"),this.controls.progress.classList.add("spkbl-ctrl","spkbl-ctrl--progress"),this.controls.progress.max="100",this.controls.progress.value="0",this.controls.progress.setAttribute("aria-label",this.options.l18n.progress),this.controls.progress.setAttribute("aria-valuenow","0"),this.controls.progress.setAttribute("aria-valuemin","0"),this.controls.progress.setAttribute("aria-valuemax","100"),this.controls.progress.setAttribute("role","progressbar"),this.controls.stop.type="button",this.controls.stop.classList.add("spkbl-ctrl","spkbl-ctrl--stop"),this.controls.stop.addEventListener("click",this.stop.bind(this))},d.prototype.setUtterances=function(t){var e=this;this.length=0,this.utterances=t.map(function(t){return t.length=t.text.length,e.length+=t.length+1,t}),this.length+=1},d.prototype.play=function(t){d.current&&d.current.halt(),(d.current=this).player.classList.add("spkbl-player--active"),this.player.classList.remove("spkbl-player--inactive"),this.controls.pause.focus(),s.addEventListener("keyup",this.escape.bind(this)),this.currentUtterance=-1,this.offset=0,this.progress=0,this.audio&&this.audioReady?(this.audio.ontimeupdate=this.boundary.bind(this),this.audio.onended=this.next.bind(this)):(speechSynthesis.cancel(),r.onboundary=this.boundary.bind(this),r.onend=this.next.bind(this)),this.next(t)},d.prototype.escape=function(t){t=t||window.event;("key"in t?"Escape"===t.key||"Esc"===t.key:27===t.keyCode)&&this.stop()},d.prototype.next=function(t){var e;this.paused?(this.nextOnResume=!0,speechSynthesis.cancel()):this.audio&&!this.audio.ended?this.audio.play():!this.audio&&this.utterances.length>this.currentUtterance+1?(0<=this.currentUtterance&&(this.offset+=this.utterances[this.currentUtterance].length+1),this.currentUtterance+=1,e=this.utterances[this.currentUtterance],r.text=e.text,r.voice=this.getUtteranceVoice(e),speechSynthesis.speak(r)):this.stop(t)},d.prototype.getUtteranceVoice=function(t){var e,s;return t.voice||(e=t.lang,s=e.split("-").shift(),t.voice=i.find(function(t){return t.lang===e||t.lang===s||t.lang.startsWith("".concat(e,"-"))||t.lang.startsWith("".concat(s,"-"))})||i.find(function(t){return t.default})||i[0]),t.voice},d.prototype.boundary=function(t){this.audio?this.progress=Number.isNaN(this.audio.duration)?0:Math.round(this.audio.currentTime/this.audio.duration*100):this.progress=Math.round(100*(this.offset+t.charIndex)/this.length),this.updateProgress()},d.prototype.updateProgress=function(){this.controls.progress.value=this.progress,this.controls.progress.setAttribute("aria-valuenow",this.progress),this.controls.progress.textContent="".concat(this.progress," % ")},d.prototype.pause=function(){this.audio?this.audio[this.togglePause(this.paused)?"pause":"play"]():(speechSynthesis[this.togglePause(this.paused)?"pause":"resume"](),this.nextOnResume&&(this.nextOnResume=!1,this.next()))},d.prototype.togglePause=function(t){return this.paused=!t,this.player.classList[t?"remove":"add"]("spkbl-player--paused"),this.controls.pause.setAttribute("aria-pressed",t?"false":"true"),this.paused},d.prototype.stop=function(){this.halt(),this.controls.play.focus()},d.prototype.halt=function(){this.audio?(this.audio.ontimeupdate=null,this.audio.onended=null,this.audio.load()):(r.onboundary=null,r.onend=null,speechSynthesis.cancel()),this.togglePause(!0),s.removeEventListener("keyup",this.escape.bind(this)),this.player.classList.add("spkbl-player--inactive"),this.player.classList.remove("spkbl-player--active"),this.player.classList.remove("spkbl-player--paused"),this.progress=0,this.updateProgress()},d.prototype.injectPlayer=function(){if("function"==typeof this.options.insert)this.options.insert(this.element,this.player);else switch(this.options.insert){case"before":this.element.parentNode.insertBefore(this.player,this.element);break;case"after":this.element.parentNode.insertBefore(this.player,this.element.nextSibling);break;default:this.element.insertBefore(this.player,this.element.firstChild)}},d.current=null,d.init=function(t){var e;return void 0===t&&(t={}),"SpeechSynthesisUtterance"in n?(t=(e=c(l,t)).selector||"",delete e.selector,(r=new SpeechSynthesisUtterance).volume=1,r.pitch=1,r.rate=1,i=speechSynthesis.getVoices().filter(function(t){return!e.local||t.localService}),speechSynthesis.addEventListener&&speechSynthesis.addEventListener("voiceschanged",function(){i=speechSynthesis.getVoices().filter(function(t){return!e.local||t.localService})}),t.length?Array.from(s.querySelectorAll(t)).map(function(t){return new d(t,e)}):[]):[]},"undefined"!=typeof exports?exports.Speakable=d:n.Speakable=d}("undefined"!=typeof global?global:window,document);
